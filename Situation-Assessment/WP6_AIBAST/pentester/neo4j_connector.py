from neo4j import GraphDatabase, basic_auth
from .pentest_types import PlannerInfo, ScanResult, ScanSummary
from .logging_setup import get_logger

logger = get_logger(__name__)



class Neo4jConnector:
    def __init__(self, uri: str, user: str, password: str):
        logger.debug("Initializing Neo4jConnector")
        self.driver = GraphDatabase.driver(uri, auth=basic_auth(user, password))
        self.scan_result_insert_query = """
            MERGE (scan:ScanResult {task_id: $task_id})
            SET scan.action = $action

            WITH scan
            UNWIND $ips AS ip
            MERGE (i:IP {address: ip})
            MERGE (scan)-[:INCLUDES]->(i)

            WITH scan
            UNWIND $new_nodes AS node
            MERGE (n:NewNode {name: node})
            MERGE (scan)-[:CREATED_NODE]->(n)

            WITH scan
            UNWIND $failed_nodes AS f
            MERGE (fip:FailedIP {address: f})
            MERGE (scan)-[:FAILED_IP]->(fip)

            WITH scan
            MERGE (summary:Summary {task_id: $task_id})
            SET summary.total = $summary_total,
                summary.successful = $summary_successful,
                summary.failures = $summary_failures

            MERGE (scan)-[:HAS_SUMMARY]->(summary)
        """

    def close(self):
        logger.debug("Closing Neo4j driver connection")
        self.driver.close()

    def run_query(self, query: str, parameters: dict = None):
        try:
            logger.debug("Running query: %s", query)
            logger.debug("With parameters: %s", parameters)
            with self.driver.session() as session:
                result = session.run(query, parameters)
                data = result.data()
                logger.debug("Query result: %s", data)
                return data
        except Exception as e:
            logger.exception("Error running query")
            return None

    def createScanResult(self, entry: ScanResult):
        try:
            logger.debug("Creating scan result: %s", entry)
            params = {
                "task_id": entry["task_id"],
                "action": entry["action"],
                "ips": entry.get("ips", []),
                "new_nodes": entry.get("new_nodes", []),
                "failed_nodes": entry.get("failed_nodes", []),
                "summary_total": entry["summary"]["total"],
                "summary_successful": entry["summary"]["successful"],
                "summary_failures": entry["summary"]["failures"],
            }

            logger.debug("Constructed parameters: %s", params)
            with self.driver.session() as session:
                result = session.run(self.scan_result_insert_query, params)
                data = result.data()
                logger.debug("Insert result: %s", data)
                return data

        except Exception as e:
            logger.exception("Exception occurred while inserting scan result")
            return None

    def getScanResultByTaskId(self, task_id: str):
        logger.debug("Fetching scan result by task_id: %s", task_id)
        query = """
        MATCH (scan:ScanResult {task_id: $task_id})
        OPTIONAL MATCH (scan)-[:INCLUDES]->(ip:IP)
        OPTIONAL MATCH (scan)-[:CREATED_NODE]->(n:NewNode)
        OPTIONAL MATCH (scan)-[:FAILED_IP]->(fip:FailedIP)
        OPTIONAL MATCH (scan)-[:HAS_SUMMARY]->(s:Summary)
        RETURN scan, collect(DISTINCT ip) as ips,
                      collect(DISTINCT n) as new_nodes,
                      collect(DISTINCT fip) as failed_ips,
                      s as summary
        """
        return self.run_query(query, {"task_id": task_id})

    def updateScanResultAction(self, task_id: str, new_action: str):
        logger.debug(
            "Updating scan result action for task_id '%s' to '%s'", task_id, new_action
        )
        query = """
        MATCH (scan:ScanResult {task_id: $task_id})
        SET scan.action = $new_action
        RETURN scan
        """
        return self.run_query(query, {"task_id": task_id, "new_action": new_action})

    def deleteScanResultByTaskId(self, task_id: str):
        logger.debug("Deleting scan result with task_id: %s", task_id)
        query = """
        MATCH (scan:ScanResult {task_id: $task_id})
        OPTIONAL MATCH (scan)-[r]-()
        DELETE r, scan
        """
        return self.run_query(query, {"task_id": task_id})

    def create_planner_info_node(self, planner_info: PlannerInfo):
        logger.debug(planner_info)
        query = """CREATE (p:PlannerInfo {ip: $ip, description: $description, 
            output: $output, output_summary: $output_summary, 
            iteration_number: $iteration_number})"""

        self.run_query(
            query,
            {
                "ip": planner_info.ip,
                "description": planner_info.description,
                "output": planner_info.output,
                "output_summary": planner_info.output_summary,
                "iteration_number": planner_info.iteration_number,
            },
        )
